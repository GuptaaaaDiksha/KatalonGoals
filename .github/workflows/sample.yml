name: Katalon-CI

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  katalon-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Java 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -yqq unzip curl jq xvfb libnss3

      - name: Get latest stable Chrome-for-Testing version
        id: get_chrome_version
        run: |
          set -e
          LATEST_VERSION=$(curl -s https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions.json | jq -r '.channels.Stable.version')
          echo "Using Chrome version: $LATEST_VERSION"
          echo "chrome_version=$LATEST_VERSION" >> $GITHUB_ENV

      - name: Download ChromeDriver and Chrome for Testing
        run: |
          set -e
          echo "Using Chrome version: $chrome_version"

          # Download ChromeDriver
          curl -s -o chromedriver.zip "https://storage.googleapis.com/chrome-for-testing-public/$chrome_version/linux64/chromedriver-linux64.zip"
          unzip chromedriver.zip
          chmod +x chromedriver-linux64/chromedriver
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/chromedriver

          # Download Chrome itself
          curl -s -o chrome.zip "https://storage.googleapis.com/chrome-for-testing-public/$chrome_version/linux64/chrome-linux64.zip"
          unzip chrome.zip
          sudo mv chrome-linux64 /opt/google/chrome
          sudo ln -sf /opt/google/chrome/chrome /usr/bin/google-chrome

      - name: Start virtual display
        run: |
          set -e
          Xvfb :99 -screen 0 1920x1080x24 &
          export DISPLAY=:99
          sleep 5

      - name: Download and Extract Katalon Studio Engine
        env:
          KATALON_API_KEY: ${{ secrets.KATALON_API_KEY }}
        run: |
          set -e
          curl -L -O "https://download.katalon.com/9.2.0/Katalon_Studio_Engine_Linux_64-9.2.0.tar.gz"
          tar -xvzf Katalon_Studio_Engine_Linux_64-9.2.0.tar.gz
          chmod +x Katalon_Studio_Engine_Linux_64-9.2.0/katalonc

      - name: Run Katalon tests
        env:
          KATALON_API_KEY: ${{ secrets.KATALON_API_KEY }}
          DISPLAY: :99
          KATALON_DISABLE_AUTO_UPDATE_DRIVER: true
        run: |
          export DISPLAY=:99
          ./Katalon_Studio_Engine_Linux_64-9.2.0/katalonc \
            -noSplash \
            -runMode=console \
            -projectPath=$(pwd)/DemoTest.prj \
            -retry=0 \
            -testSuitePath="Test Suites/DemoSuite" \
            -executionProfile="default" \
            -browserType="Chrome (headless)" \
            -apiKey="${KATALON_API_KEY}" \
            --config webui.driver.chrome.path=/usr/local/bin/chromedriver
